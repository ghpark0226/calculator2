<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>체내 잔류 카페인 계산기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="icon.png" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2563eb" />
  <link rel="apple-touch-icon" href="icon.png" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card-border: #e5e7eb;
      --card-shadow: rgba(15,23,42,0.1);
      --accent: #2563eb;
      --accent-soft: #e0edff;
      --text-main: #111827;
      --text-muted: #6b7280;
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      min-height:100vh;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
      background: radial-gradient(circle at top, #e0edff 0, #f9fafb 55%);
      color: var(--text-main);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      font-size:16px;
    }

    .app-shell{
      width:100%;
      max-width:720px;
      padding:18px 12px 72px;
    }

    .app {
      background:#ffffff;
      border-radius:24px;
      padding:0px;
      box-shadow:0 10px 50px var(--card-shadow);
      border:1px solid var(--card-border);
    }

    .app-inner{
      border-radius:23px;
      background:linear-gradient(135deg,#ffffff 0%,#ffffff 60%,#f3f4ff 100%);
      padding:20px 20px 18px;
    }

    .half-life-note {
      margin-top:6px;
      font-size:0.85rem;
      color:var(--text-muted);
      text-align:center;
    }

    h1{
      margin:0;
      font-size:1.8rem;
      letter-spacing:-0.03em;
    }

    .header-row{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-end;
    }

    .subtitle{
      margin-top:4px;
      font-size:0.95rem;
      color:#6b7280;
    }

    .section{
      margin-top:18px;
      padding:12px 12px 10px;
      border-radius:16px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }

    .section-title{
      font-size:0.95rem;
      font-weight:600;
      color:#111827;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .section-title span.dot{
      width:6px;height:6px;border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 0 3px rgba(37,99,235,0.2);
    }

    .picker-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    select{
      padding:7px 10px;
      border-radius:10px;
      border:1px solid #d1d5db;
      background:#ffffff;
      color:var(--text-main);
      font-size:16px;
      min-width:80px;
      outline:none;
      appearance:none;
      position:relative;
    }
    select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(37,99,235,0.35);
    }

    button{
      border:0;
      border-radius:999px;
      padding:8px 15px;
      font-size:15px;
      cursor:pointer;
      transition:all .15s ease-out;
      font-weight:500;
    }

    .btn-primary{
      background:linear-gradient(135deg,#3b82f6,#60a5fa);
      color:white;
      box-shadow:0 8px 18px rgba(37,99,235,0.25);
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 35px rgba(37,99,235,0.4);
    }
    .btn-primary:active{
      transform:translateY(0);
      box-shadow:0 8px 18px rgba(37,99,235,0.25);
    }

    .btn-ghost{
      background:#ffffff;
      color:var(--text-main);
      border:1px solid #d1d5db;
      padding:6px 12px;
    }
    .btn-ghost:hover{
      background:#eff6ff;
      border-color:#93c5fd;
    }

    .current-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }

    .dose-header-row{
      margin-top:16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .dose-header-row-title{
      font-size:0.95rem;
      font-weight:600;
      color:#6b7280;
    }

    .dose-table-wrap{
      margin-top:8px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid #e5e7eb;
      background:#ffffff;
    }

    .dose-table{
      width:100%;
      border-collapse:collapse;
      font-size:0.9rem;
    }

    .dose-table thead{
      background:#f3f4f6;
    }

    .dose-table thead th{
      padding:8px 10px;
      font-weight:500;
      color:#6b7280;
      border-bottom:1px solid #e5e7eb;
      text-align:center;
      letter-spacing:0.02em;
    }

    .dose-table tbody tr{
      border-bottom:1px solid #f3f4f6;
    }

    .dose-table tbody tr:last-child{
      border-bottom:none;
    }

    .dose-table tbody td{
      padding:7px 8px;
      vertical-align:middle;
    }

    .dose-time-picker{
      display:flex;
      gap:6px;
      justify-content:flex-start;
      align-items:center;
    }
    .dose-time-picker select{
      min-width:84px;
      font-size:16px;
    }

    .mg-cell{
      text-align:center;
    }

    .mg-input-wrap{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 8px;
      border-radius:999px;
      background:#f9fafb;
      border:1px solid #d1d5db;
    }

    .mg-input-wrap input{
      width:70px;
      border:none;
      background:transparent;
      color:var(--text-main);
      font-size:16px;
      text-align:right;
      padding:0;
      outline:none;
    }

    .mg-unit{
      font-size:0.8rem;
      color:var(--text-muted);
    }

    .result-box{
      margin-top:18px;
      border-radius:16px;
      padding:14px 14px 12px;
      background:var(--accent-soft);
      border:1px solid #bfdbfe;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .result-value{
      font-weight:600;
      font-size:1.1rem;
      letter-spacing:0.02em;
    }

    /* 타임라인 */
    .timeline-section{
      margin-top:18px;
      padding:12px;
      border-radius:16px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      position:relative; /* floating date용 기준 */
    }
    .timeline-wrap{
      margin-top:8px;
      overflow-x:auto;
      padding-bottom:4px;
    }
    .timeline-table{
      border-collapse:collapse;
      min-width:760px;
      font-size:0.8rem;
    }
    .timeline-table th,
    .timeline-table td{
      border:1px solid #e5e7eb;
      padding:4px 6px;
      text-align:center;
      white-space:nowrap;
    }
    .timeline-table th{
      background:#f3f4f6;
      font-weight:500;
      color:#6b7280;
    }
    .timeline-row-label{
      position:sticky;
      left:0;
      background:#f9fafb;
      font-weight:500;
      min-width:70px;
      text-align:left;
      padding-left:6px;
      z-index:3;
    }
    .timeline-date-cell{
      background:#f3f4f6;
    }
    .timeline-cell{
      min-width:34px;
      font-variant-numeric:tabular-nums;
      color:#111827;
    }
    .timeline-empty{
      font-size:0.85rem;
      color:#9ca3af;
      padding:6px 0 2px;
    }

    /* 떠 있는 날짜 라벨 */
    .timeline-floating-date{
      position:absolute;
      top:34px;
      left:16px;
      padding:2px 10px;
      border-radius:999px;
      background:#e5e7eb;
      font-size:0.75rem;
      color:#374151;
      pointer-events:none;
      z-index:5;
      display:none;
    }

    .caffeine-section{
      margin-top:10px;
      padding:10px 4px 0;
      font-size:0.8rem;
      color:var(--text-muted);
    }

    .caffeine-title{
      font-weight:600;
      font-size:0.9rem;
      margin-bottom:6px;
      text-align:center;
    }

    .caffeine-table-wrap{
      border-radius:12px;
      overflow:hidden;
      border:1px solid #e5e7eb;
      background:#ffffff;
    }

    .caffeine-table{
      width:100%;
      border-collapse:collapse;
      font-size:0.78rem;
    }

    .caffeine-table th,
    .caffeine-table td{
      padding:4px 6px;
      border-bottom:1px solid #e5e7eb;
      text-align:center;
      white-space:nowrap;
    }

    .caffeine-table th{
      background:#f3f4f6;
      font-weight:500;
      color:#6b7280;
    }

    .caffeine-table tr:last-child td{
      border-bottom:none;
    }

    .caffeine-subheading td{
      background:#f9fafb;
      font-weight:600;
      text-align:left;
      padding-top:6px;
    }

    .caffeine-note{
      margin-top:6px;
      font-size:0.7rem;
      color:#9ca3af;
      text-align:right;
    }

    .signature{
      margin-top:14px;
      margin-bottom:10px;
      font-size:0.8rem;
      text-align:center;
      color:#9ca3af;
    }

    /* 모바일 */
    .cell-label-mobile{
      display:none;
      font-size:0.8rem;
      color:#6b7280;
      margin-bottom:4px;
    }

    @media (max-width:720px){
      .app-inner{ padding:16px 14px 14px; }

      .dose-table thead{ display:none; }

      .dose-table tbody tr{
        display:block;
        padding:8px 10px;
        border-bottom:1px solid #e5e7eb;
      }

      .dose-table tbody td{
        display:block;
        padding:4px 0;
      }

      .dose-time-picker{
        flex-wrap:wrap;
      }

      .dose-time-picker select{
        flex:1 1 45%;
        min-width:0;
      }

      .cell-label-mobile{
        display:block;
      }

      .mg-cell{
        text-align:left;
      }

      .mg-input-wrap{
        width:100%;
        justify-content:flex-start;
      }

      .result-box{
        flex-direction:column;
        align-items:flex-start;
      }

      .timeline-table{
        font-size:0.75rem;
        min-width:640px;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <div class="app">
    <div class="app-inner">
      <div class="header-row">
        <div>
          <h1>체내 잔류 카페인 계산기</h1>
          <div class="subtitle">이전에 섭취한 카페인이 체내에 얼마나 남아있을까요?<br>카페인 반감기에 기반하여 계산해보세요!</div>
        </div>
      </div>

      <!-- 기준 시각 -->
      <div class="section" style="margin-top:18px;">
        <div class="section-title">
          <span class="dot"></span>
          <span>기준 시각</span>
        </div>
        <div class="picker-row">
          <select id="curYear"></select>
          <select id="curMonth"></select>
          <select id="curDay"></select>
          <select id="curHour"></select>
        </div>
        <div class="current-actions">
          <button class="btn-ghost" id="setNowBtn">지금으로 설정</button>
        </div>
      </div>

      <!-- 섭취 기록 -->
      <div class="dose-header-row">
        <div class="dose-header-row-title">카페인 섭취 기록</div>
        <button class="btn-primary" id="addDoseBtn">+ 기록 추가</button>
      </div>

      <div class="dose-table-wrap">
        <table class="dose-table">
          <thead>
          <tr>
            <th style="text-align:left;padding-left:14px;">연/월/일 시</th>
            <th>용량</th>
            <th></th>
          </tr>
          </thead>
          <tbody id="doseTbody"></tbody>
        </table>
      </div>

      <!-- 결과 -->
      <div class="result-box">
        <div id="resultMain" class="result-value">누적 잔류 카페인: 0</div>
      </div>

      <!-- 타임라인 -->
      <div class="timeline-section">
        <div class="section-title" style="margin-top:0;">
          <span class="dot"></span>
          <span>잔류 카페인 타임라인</span>
        </div>
        <div class="timeline-wrap" id="timelineWrap">
          <div class="timeline-empty">카페인 섭취를 기록하면 타임라인이 표시됩니다.</div>
        </div>
        <div class="timeline-floating-date" id="timelineFloatingDate"></div>
      </div>

    </div>
  </div>
  <div class="half-life-note">*카페인 반감기는 5시간으로 계산되었습니다.<br>실제 카페인 반감기는 개인마다 차이가 있을 수 있습니다.<br>&nbsp;</div>

  <div class="caffeine-section">
    <div class="caffeine-title">참고: 주요 음료 및 커피 제품의 카페인 함량 (추정치)</div>
    <div class="caffeine-table-wrap">
      <table class="caffeine-table">
        <thead>
        <tr>
          <th>제품</th>
          <th>용량</th>
          <th>카페인</th>
        </tr>
        </thead>
        <tbody>
        <!-- 에너지드링크 -->
        <tr class="caffeine-subheading">
          <td colspan="3" style="text-align: center;">에너지 드링크</td>
        </tr>
        <tr>
          <td>몬스터 에너지 355ml</td>
          <td>355&nbsp;ml</td>
          <td>100&nbsp;mg</td>
        </tr>
        <tr>
          <td>몬스터 에너지 500ml</td>
          <td>500&nbsp;ml</td>
          <td>200&nbsp;mg</td>
        </tr>
        <tr>
          <td>핫식스 250ml</td>
          <td>250&nbsp;ml</td>
          <td>60&nbsp;mg</td>
        </tr>
        <tr>
          <td>핫식스 355ml</td>
          <td>355&nbsp;ml</td>
          <td>100&nbsp;mg</td>
        </tr>
        <tr>
          <td>핫식스 500ml</td>
          <td>500&nbsp;ml</td>
          <td>200&nbsp;mg</td>
        </tr>
        <tr>
          <td>넷플릭스 에너지드링크</td>
          <td>500&nbsp;ml</td>
          <td>200-250&nbsp;mg</td>
        </tr>

        <!--캔커피 -->
        <tr class="caffeine-subheading">
          <td colspan="3" style="text-align: center;">캔 커피</td>
        </tr>
        <tr>
          <td>조지아 마운틴블렌드</td>
          <td>270&nbsp;ml</td>
          <td>160&nbsp;mg</td>
        </tr>
        <tr>
          <td>조지아 오리지널</td>
          <td>240&nbsp;ml</td>
          <td>130&nbsp;mg</td>
        </tr>
        <tr>
          <td>조지아 맥스커피</td>
          <td>240&nbsp;ml</td>
          <td>130&nbsp;mg</td>
        </tr>
        <tr>
          <td>프렌치카페 에스프레소 골드</td>
          <td>250&nbsp;ml</td>
          <td>120&nbsp;mg</td>
        </tr>

        <!-- 스타벅스 아메리카노 -->
        <tr class="caffeine-subheading">
          <td colspan="3" style="text-align: center;">스타벅스 카페 아메리카노 (1 shot = 75 mg)</td>
        </tr>
        <tr>
          <td>Short</td>
          <td>8oz</td>
          <td>75&nbsp;mg</td>
        </tr>
        <tr>
          <td>Tall</td>
          <td>12oz</td>
          <td>150&nbsp;mg</td>
        </tr>
        <tr>
          <td>Grande</td>
          <td>16oz</td>
          <td>225&nbsp;mg</td>
        </tr>
        <tr>
          <td>Venti</td>
          <td>20oz</td>
          <td>300&nbsp;mg</td>
        </tr>

        <!-- 스타벅스 라떼 -->
        <tr class="caffeine-subheading">
          <td colspan="3" style="text-align: center;">스타벅스 카페 라떼 (1 shot = 75 mg)</td>
        </tr>
        <tr>
          <td>Short</td>
          <td>8oz</td>
          <td>75&nbsp;mg</td>
        </tr>
        <tr>
          <td>Tall</td>
          <td>12oz</td>
          <td>75&nbsp;mg</td>
        </tr>
        <tr>
          <td>Grande</td>
          <td>16oz</td>
          <td>150&nbsp;mg</td>
        </tr>
        <tr>
          <td>Venti</td>
          <td>20oz</td>
          <td>150&nbsp;mg</td>
        </tr>
        </tbody>
      </table>
    </div>
    <div class="caffeine-note">
    </div>
  </div>

  <div class="signature">만든이: 연세대학교 QRM 25 박규혁<br>문의: ghpark0226@gmail.com<br>버전: 1.0<br></div>
</div>

<script>
  const HALF_LIFE = 5;
  const SAFE_LEVEL = 400;
  const THRESHOLD = 0.5; // 이 이하로 내려가면 0으로 간주

  function pad(n){return n<10?"0"+n:n;}

  const ySel = document.getElementById("curYear");
  const mSel = document.getElementById("curMonth");
  const dSel = document.getElementById("curDay");
  const hSel = document.getElementById("curHour");

  function populateYearOptions(){
    for(let y = 2025; y <= 2030; y++){
      const op = document.createElement("option");
      op.value = y;
      op.text = y + "년";
      ySel.appendChild(op);
    }
  }

  function populateMonthOptions(){
    for(let m=1;m<=12;m++){
      const op=document.createElement("option");
      op.value=m; op.text=m+"월";
      mSel.appendChild(op);
    }
  }

  function populateDayOptions(year, month, selectedDay){
    dSel.innerHTML="";
    const last = new Date(year, month, 0).getDate();
    for(let d=1; d<=last; d++){
      const op=document.createElement("option");
      op.value=d; op.text=d+"일";
      if(d===selectedDay) op.selected=true;
      dSel.appendChild(op);
    }
  }

  function populateHourOptions(){
    for(let h=0;h<24;h++){
      const op=document.createElement("option");
      op.value=h; op.text=pad(h)+"시";
      hSel.appendChild(op);
    }
  }

  function clampYearToRange(year){
    if(year < 2025) return 2025;
    if(year > 2030) return 2030;
    return year;
  }

  function setCurrentToNow(){
    const now = new Date();
    const year = clampYearToRange(now.getFullYear());

    ySel.value = year.toString();
    mSel.value = (now.getMonth()+1).toString();
    populateDayOptions(year, now.getMonth()+1, now.getDate());
    hSel.value = now.getHours().toString();
    autoCalc();
  }

  function initCurrentPicker(){
    populateYearOptions();
    populateMonthOptions();
    populateHourOptions();
    setCurrentToNow();

    ySel.onchange = () => {
      const year = parseInt(ySel.value);
      const month = parseInt(mSel.value);
      const day = parseInt(dSel.value) || 1;
      populateDayOptions(year, month, Math.min(day, new Date(year, month, 0).getDate()));
      autoCalc();
    };
    mSel.onchange = () => {
      const year = parseInt(ySel.value);
      const month = parseInt(mSel.value);
      const day = parseInt(dSel.value) || 1;
      populateDayOptions(year, month, Math.min(day, new Date(year, month, 0).getDate()));
      autoCalc();
    };
    dSel.onchange = autoCalc;
    hSel.onchange = autoCalc;

    document.getElementById("setNowBtn").onclick = setCurrentToNow;
  }

  function getNowDate(){
    const y = parseInt(ySel.value);
    const m = parseInt(mSel.value);
    const d = parseInt(dSel.value);
    const h = parseInt(hSel.value);
    const dt = new Date(`${y}-${pad(m)}-${pad(d)}T${pad(h)}:00`);
    dt.setMinutes(0,0,0);
    return dt;
  }

  function addDoseRow(){
    const tbody = document.getElementById("doseTbody");
    const tr = document.createElement("tr");
    tbody.appendChild(tr);

    tr.innerHTML = `
      <td class="pick">
        <div class="cell-label-mobile">연/월/일 시</div>
      </td>
      <td class="mg-cell">
        <div class="cell-label-mobile">용량</div>
        <div class="mg-input-wrap">
          <input type="number" min="0" step="10" />
          <span class="mg-unit">mg</span>
        </div>
      </td>
      <td style="text-align:center;">
        <button class="btn-ghost del">삭제</button>
      </td>
    `;

    const baseDate = getNowDate();
    createTimePickerForRow(tr, baseDate);

    tr.querySelector(".del").onclick = () => { tr.remove(); autoCalc(); };
    tr.querySelector("input").oninput = autoCalc;

    autoCalc();
  }

  function createTimePickerForRow(tr, date){
    const td = tr.querySelector(".pick");
    const wrap = document.createElement("div");
    wrap.className = "dose-time-picker";
    wrap.innerHTML = `
      <select class="y"></select>
      <select class="m"></select>
      <select class="d"></select>
      <select class="h"></select>
    `;
    td.appendChild(wrap);

    const ySelR = wrap.querySelector(".y");
    const mSelR = wrap.querySelector(".m");
    const dSelR = wrap.querySelector(".d");
    const hSelR = wrap.querySelector(".h");

    for(let y = 2025; y <= 2030; y++){
      const op = document.createElement("option");
      op.value = y;
      op.text = y + "년";
      if(y === clampYearToRange(date.getFullYear())) op.selected = true;
      ySelR.appendChild(op);
    }

    for(let m=1;m<=12;m++){
      const op=document.createElement("option");
      op.value=m; op.text=m+"월";
      if(m===date.getMonth()+1) op.selected=true;
      mSelR.appendChild(op);
    }

    function loadDaysRow(selected){
      dSelR.innerHTML="";
      const year = parseInt(ySelR.value);
      const month = parseInt(mSelR.value);
      const last = new Date(year, month, 0).getDate();
      const daySafe = Math.min(selected, last);
      for(let d=1; d<=last; d++){
        const op=document.createElement("option");
        op.value=d; op.text=d+"일";
        if(d===daySafe) op.selected=true;
        dSelR.appendChild(op);
      }
    }
    loadDaysRow(date.getDate());

    for(let h=0;h<24;h++){
      const op=document.createElement("option");
      op.value=h; op.text=pad(h)+"시";
      if(h===date.getHours()) op.selected=true;
      hSelR.appendChild(op);
    }

    [ySelR,mSelR,dSelR,hSelR].forEach(sel => sel.onchange = autoCalc);
  }

  function collectDoses(){
    const rows = document.querySelectorAll("#doseTbody tr");
    const doses = [];
    rows.forEach(row => {
      const td = row.querySelector(".pick");
      if(!td) return;
      const yEl = td.querySelector(".y");
      const mEl = td.querySelector(".m");
      const dEl = td.querySelector(".d");
      const hEl = td.querySelector(".h");
      if(!yEl || !mEl || !dEl || !hEl) return;

      const y = parseInt(yEl.value);
      const m = parseInt(mEl.value);
      const d = parseInt(dEl.value);
      const h = parseInt(hEl.value);
      const mg = parseFloat(row.querySelector("input").value);
      if(!mg || isNaN(mg)) return;

      const t = new Date(`${y}-${pad(m)}-${pad(d)}T${pad(h)}:00`);
      t.setMinutes(0,0,0);
      doses.push({time: t, mg});
    });
    return doses;
  }

  // 색: 0~20 => 흰색, 20~400 사이 점점 진해짐, 400 이상 고정
  function colorFor(v){
    if(v <= 20 || isNaN(v)) return 'rgb(255,255,255)';
    const capped = Math.min(v, SAFE_LEVEL);
    const t = (capped - 20) / (SAFE_LEVEL - 20); // 0~1
    const baseR = 235, baseG = 243, baseB = 255;
    const darkR = 90,  darkG = 130, darkB = 220;
    const r = Math.round(baseR + (darkR - baseR) * t);
    const g = Math.round(baseG + (darkG - baseG) * t);
    const b = Math.round(baseB + (darkB - baseB) * t);
    return `rgb(${r},${g},${b})`;
  }

  // floating date 업데이트
  function updateFloatingDate(dateGroups, slots){
    const wrap = document.getElementById('timelineWrap');
    const table = wrap.querySelector('.timeline-table');
    const float = document.getElementById('timelineFloatingDate');
    if(!wrap || !table || !float || !dateGroups || !dateGroups.length) return;

    const wrapRect = wrap.getBoundingClientRect();
    const headerRows = table.querySelectorAll('thead tr');
    if(headerRows.length < 2) return;
    const dateRow = headerRows[0];
    const timeRow = headerRows[1];

    const dateCells = Array.from(dateRow.querySelectorAll('.timeline-date-cell'));
    const timeCells = Array.from(timeRow.querySelectorAll('th')).slice(1); // 첫 th는 "행"

    let chosenLabel = null;
    let chosenSide = 'left';

    for(let i=0;i<dateGroups.length;i++){
      const g = dateGroups[i];
      const startIdx = g.startIndex;
      const endIdx = g.startIndex + g.count - 1;
      const dateCell = dateCells[i];
      if(!dateCell) continue;

      const dateRect = dateCell.getBoundingClientRect();

      // 날짜 헤더가 화면 안에 보이는 경우: 떠 있는 라벨 사용 X
      const dateVisible = dateRect.right > wrapRect.left && dateRect.left < wrapRect.right;
      if(dateVisible){
        chosenLabel = null;
        break;
      }

      const firstTh = timeCells[startIdx];
      const lastTh  = timeCells[endIdx];
      if(!firstTh || !lastTh) continue;
      const firstRect = firstTh.getBoundingClientRect();
      const lastRect  = lastTh.getBoundingClientRect();

      const visible = lastRect.left < wrapRect.right && firstRect.right > wrapRect.left;
      if(!visible) continue;

      // 이 날짜 구간은 현재 화면에 보이지만, 날짜 셀은 이미 왼/오로 나감
      chosenLabel = `${g.date.getMonth()+1}/${g.date.getDate()}`;
      if(dateRect.right <= wrapRect.left){
        chosenSide = 'left';
      }else if(dateRect.left >= wrapRect.right){
        chosenSide = 'right';
      }else{
        chosenSide = 'left';
      }
      break;
    }

    if(chosenLabel){
      float.textContent = chosenLabel;
      float.style.display = 'inline-block';
      if(chosenSide === 'left'){
        float.style.left = '16px';
        float.style.right = 'auto';
      }else{
        float.style.left = 'auto';
        float.style.right = '16px';
      }
    }else{
      float.style.display = 'none';
    }
  }

  function buildTimeline(doses){
    const wrapper = document.getElementById("timelineWrap");
    if(!doses.length){
      wrapper.innerHTML = '<div class="timeline-empty">카페인 섭취를 추가하면 타임라인이 표시됩니다.</div>';
      const float = document.getElementById('timelineFloatingDate');
      if(float) float.style.display='none';
      return;
    }

    const lambda = Math.LN2 / HALF_LIFE;

    // 시작 시각: 가장 이른 섭취 시각의 시 단위 내림
    let minTime = doses[0].time;
    doses.forEach(d=>{
      if(d.time < minTime) minTime = d.time;
    });
    const start = new Date(minTime.getTime());
    start.setMinutes(0,0,0);

    // 끝 시각: 각 섭취가 THRESHOLD 이하로 떨어지는 마지막 시각들 중 최댓값
    let maxTime = doses[0].time;
    doses.forEach(d=>{
      const mg = d.mg;
      if(mg <= THRESHOLD) return;
      const tHours = Math.log(mg / THRESHOLD) / lambda;
      const candidate = new Date(d.time.getTime() + tHours * 3600000);
      if(candidate > maxTime) maxTime = candidate;
    });
    const end = new Date(maxTime.getTime());
    end.setMinutes(0,0,0);
    if(end.getTime() < maxTime.getTime()){
      end.setHours(end.getHours()+1);
    }

    // 슬롯 (1시간 간격)
    const slots = [];
    for(let t = new Date(start.getTime()); t.getTime() <= end.getTime(); t.setHours(t.getHours()+1)){
      slots.push(new Date(t.getTime()));
    }

    // 날짜 그룹 (startIndex 포함)
    const dateGroups = [];
    let curKey = null, curCount = 0, curDate = null, startIndex = 0;
    slots.forEach((t,idx)=>{
      const key = `${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}`;
      if(key !== curKey){
        if(curKey !== null){
          dateGroups.push({key:curKey,count:curCount,date:curDate,startIndex:startIndex});
        }
        curKey = key;
        curCount = 1;
        curDate = new Date(t.getFullYear(), t.getMonth(), t.getDate());
        startIndex = idx;
      }else{
        curCount++;
      }
    });
    if(curKey !== null){
      dateGroups.push({key:curKey,count:curCount,date:curDate,startIndex:startIndex});
    }

    // per-dose & total
    const perDoseValues = [];
    const totalValues = new Array(slots.length).fill(0);

    doses.forEach((dose, idx)=>{
      perDoseValues[idx] = [];
      slots.forEach((slot, i)=>{
        const diff = (slot - dose.time)/3600000;
        let val = 0;
        if(diff >= 0){
          val = dose.mg * Math.exp(-lambda * diff);
        }
        if(val < THRESHOLD) val = 0;
        perDoseValues[idx][i] = val;
        totalValues[i] += val;
      });
    });

    // 테이블 HTML
    let html = '<table class="timeline-table"><thead>';

    // 날짜 행
    html += '<tr>';
    html += '<th class="timeline-row-label"></th>';
    dateGroups.forEach(g=>{
      const d = g.date;
      const label = `${d.getMonth()+1}/${d.getDate()}`;
      html += `<th class="timeline-date-cell" colspan="${g.count}" data-start="${g.startIndex}" data-end="${g.startIndex+g.count-1}">${label}</th>`;
    });
    html += '</tr>';

    // 시간 행
    html += '<tr>';
    html += '<th class="timeline-row-label">행</th>';
    slots.forEach((s)=>{
      html += `<th>${s.getHours()}시</th>`;
    });
    html += '</tr></thead><tbody>';

    // 합계 행
    html += '<tr>';
    html += '<td class="timeline-row-label">합계</td>';
    totalValues.forEach((v)=>{
      const bg = colorFor(v);
      const val = Math.round(v);
      html += `<td class="timeline-cell" style="background:${bg};">${val}</td>`;
    });
    html += '</tr>';

    // 개별 섭취 행
    doses.forEach((dose, idx)=>{
      html += '<tr>';
      html += `<td class="timeline-row-label">섭취 ${idx+1}</td>`;
      perDoseValues[idx].forEach((v)=>{
        const bg = colorFor(v);
        const val = Math.round(v);
        html += `<td class="timeline-cell" style="background:${bg};">${val}</td>`;
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    wrapper.innerHTML = html;

    const wrapEl = document.getElementById('timelineWrap');
    const onScroll = () => updateFloatingDate(dateGroups, slots);
    wrapEl.onscroll = onScroll;
    updateFloatingDate(dateGroups, slots);
  }

  function autoCalc(){
    const lambda = Math.LN2 / HALF_LIFE;
    const doses = collectDoses();
    const calcTime = getNowDate();

    let sumNow = 0;
    doses.forEach(d=>{
      const diff = (calcTime - d.time) / 3600000;
      if(diff >= 0){
        let val = d.mg * Math.exp(-lambda * diff);
        if(val < THRESHOLD) val = 0;
        sumNow += val;
      }
    });

    const left = Math.round(sumNow);
    document.getElementById("resultMain").innerHTML =
      `잔류 카페인: ${left}`;

    buildTimeline(doses);
  }

  initCurrentPicker();
  autoCalc();
  document.getElementById("addDoseBtn").onclick = addDoseRow;
</script>
</body>
</html>
